---
rsyslog_configure: install
rsyslog_packages:
  - rsyslog
rsyslog_services:
  - rsyslog
rsyslog_enable: false


rsyslog_work_dir: /var/spool/rsyslog
rsyslog_main_conf_file: /etc/rsyslog.conf
rsyslog_custom_conf_dir: /etc/rsyslog.d
rsyslog_include_conf_files_dir: /etc/rsyslog.d/*.conf


rsyslog_global_conf: 
  umask: "0022"
  workDirectory: "{{ rsyslog_work_dir }}"
  net.enableDNS: "on"
  preserveFQDN: "on"
  processInternalMessages: "off"


rsyslog_global_include:
  - file: /etc/rsyslog.d/*.conf
    optionnal: true
  # - file: /etc/rsyslog_test.conf
  #   optionnal: false


rsyslog_global_module:
  - name: imuxsock
    load_name: ""
    options:
      SysSock.Use: "on"
  - name: imjournal
    load_name: ""
    options:
      StateFile: imjournal.state
      IgnoreNonValidStatefile: "on"
  - name: imklog
    load_name: ""
    options: []
  - name: immark
    load_name: ""
    options: []
  # - name: imfile
  #   load_name: ""
  #   options: []
  - name: imtcp
    load_name: ""
    options: []
  - name: imudp
    load_name: ""
    options: []
  - name: omfile
    load_name: "builtin:omfile"
    options: []
  - name: omfwd
    load_name: "builtin:omfwd"
    options: []
  - name: omusrmsg
    load_name: "builtin:omusrmsg"
    options: []


rsyslog_global_listener:
  # - name: file_imput
  #   type: imfile
  #   options: []
  - name: udp_514
    type: imudp
    options:
      port: 514
  - name: tcp_514
    type: imtcp
    options:
      port: 514


rsyslog_global_template:
  - name: tpl_list
    type: list
    options: []
    list:
      - constant: 
          value: "Syslog MSG is: '"
      - property:
          name: "msg"
      - constant: 
          value: "', "
      - property:
          name: "timereported"
          dateFormat: "rfc3339"
          caseConversion: "lower"

  - name: tpl_subtree
    type: subtree
    options: []
    subtree: "$!usr!tpl2"

  - name: tpl_string
    type: string
    options: []
    string: "teststring"

  # - name: tpl_plugin
  #   type: plugin
  #   options: []
  #   plugin: "testplugin"



rsyslog_global_ruleset:
  - name: toto
    rules:
      - condition: "$msg contains 'toto'"
        type: action
        # type: stop
        # type: call
        # call: 
        actions:
        - module: omfile
          options: 
            File: /var/log/toto
          stop_after: false
        - module: omfwd
          options:
            protocol: udp
            target: toto.infra.ginhoux.net
            port: 514
          stop_after: false
        stop_after: false
      - condition: ""
        # type: action
        # type: call
        type: stop
        # module: 
        # options: []
        # stop_after: false

  - name: titi
    rules:
      - condition: "$syslogfacility-text == 'daemon' and $msg contains 'titi'"
        type: action
        # type: stop
        # type: call
        # call: 
        actions:
        - module: omfile
          options: 
            File: /var/log/titi
          stop_after: false
        stop_after: false
        
      - condition: "$syslogseverity-text == 'warn'"
        type: action
        # type: stop
        # type: call
        # call: 
        actions:
        - module: omfile
          options: 
            File: /var/log/titi_warn
          stop_after: false
        - module: omfwd
          options:
            protocol: udp
            target: titi.infra.ginhoux.net
            port: 514
          stop_after: false
        stop_after: false


rsyslog_filters_files:
  - name: 00_iptables
    description: "manage iptables logs"
    filters:
      - description: "only iptables drop msg, all in file and only severity 4 forwarded"
        condition: >-
                  $syslogfacility-text == 'kern'
                  and
                  $msg contains 'iptables'
                  and
                  $msg contains 'drop'
        type: action
        # type: ruleset
        # type: call
        # type: stop
        # call: toto
        ruleset:
          name: iptables_drop
          rules:
            - condition: ""
              type: action
              # type: stop
              # type: call
              # call: 
              actions:
              - module: omfile
                options: 
                  File: /var/log/iptables_drop
                stop_after: false
              - module: omfile
                options: 
                  File: /var/log/iptables_drop2
                stop_after: false
              stop_after: false

            - condition: ""
              # type: action
              # type: call
              type: stop
              # module: 
              # options: []
              # stop_after: false

            - condition: ""
              type: call
              call: titi
              # module: 
              # options: []
              stop_after: false

            - condition: >-
                         $syslogseverity-text == 'warn'
              type: action
              # type: stop
              # type: call
              # call: 
              actions:
                - module: omfwd
                  options:
                    protocol: udp
                    target: rsyslog1.infra.ginhoux.net
                    port: 514
                  stop_after: false
                - module: omfwd
                  options:
                    protocol: udp
                    target: rsyslog2.infra.ginhoux.net
                    port: 514
                  stop_after: false
              stop_after: false

        actions:
          - module: omfwd
            options:
              protocol: tcp
              target: rsyslog33.infra.ginhoux.net
              port: 5555
            stop_after: false

          - module: omfwd
            options:
              protocol: udp
              target: rsyslog44.infra.ginhoux.net
              port: 9999
            stop_after: false




